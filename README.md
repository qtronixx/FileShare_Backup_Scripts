  Скрипт резервного копирования и одностороннего зеркалирования сетевой файловой шары на локальный диск, использующий многопоточность и гибкую систему оповещения Telegram.
 

  Этот скрипт выполняет одностороннее **зеркалирование** (`/MIR`) сетевого ресурса, указанного в `$SOURCE`, на локальный диск `$DESTINATION`. Скрипт настроен на работу с резервным копированием, включая копирование прав безопасности (`/SEC`) и атрибутов (`/COPY:DATS`).

  **Оптимизация и устойчивость:**
  - **Многопоточность:** Используется `/MT:64` для ускорения синхронизации и максимальной утилизации канала.
  - **Устойчивость:** При сбоях копирования выполняются **5 повторных попыток** (`/R:5`) с интервалом в **5 секунд** (`/W:5`), чтобы преодолеть временные блокировки.
  - **Исключения:** Настроены списки для игнорирования временных, системных файлов и каталогов (`/XF`, `/XD`, `/XJ`).

  **Продвинутая обработка ошибок:**
  - Скрипт не полагается только на код завершения Robocopy (`$LASTEXITCODE`), который является суммой битовых флагов.
  - Он использует настраиваемые списки: `$NonCriticalExitCodes` и `$CriticalErrorHexCodes` для точного определения критичности сбоя.
  - Если код завершения находится в списке некритических, но в логе обнаруживаются **заданные HEX-коды критических ошибок Win32** (например, Отказано в доступе), статус задачи повышается до **"ВНИМАНИЕ"**.

  **Оповещение:** При запуске, успешном завершении, предупреждении или критическом сбое отправляется подробное уведомление в Telegram.

  Автоматически сгенерированный путь к файлу лога. Используется для записи всего вывода Robocopy, а также информации о начале, завершении и ошибках скрипта. Лог-файл необходим для анализа HEX-кодов ошибок Robocopy.
 

  Версия: 1.6
  Автор: Dmitry V Orlov
  Дата: 16.12.2025
  Требования: Запуск под доменной сервисной учетной записью с правами чтения всей файловой шары.
 Изменения:
    - **Добавлена ротация лог-файлов** с архивированием в папки YYYY/MM.
    - Добавлена гибкая система определения критических ошибок через $NonCriticalExitCodes.
    - Добавлен опциональный анализ лога на наличие критических паттернов ($CriticalErrorPatterns).
  
  **Параметры Robocopy в действии:**
  - `/MIR /SEC`: Зеркалирование с сохранением разрешений.
  - `/MT:64`: Многопоточность (64 потока).
  - `/R:5 /W:5`: 5 повторов, 5 секунд ожидания.
  - `/NP /XA:SH /XJ /NFL /NDL /NS`: Подавление вывода статуса и исключение служебных файлов/точек соединения.

  **Логика оповещения:**
  - **УСПЕХ:** Код возврата находится в `$NonCriticalExitCodes` И в логе **не** найдены `$CriticalErrorHexCodes`.
  - **ВНИМАНИЕ:** Код возврата находится в `$NonCriticalExitCodes`, но в логе **найдены** `$CriticalErrorHexCodes`.
  - **КРИТИЧЕСКИЙ СБОЙ:** Код возврата **не** находится в `$NonCriticalExitCodes` (обычно 16 и выше).
 
EXAMPLE
  Get-Help .\sync_share.ps1 -Full 
  # Показать полную справку по скрипту.
  
EXAMPLE
  .\sync_share.ps1 
  # Запустить скрипт с заданными в коде параметрами $SOURCE и $DESTINATION.

LINK
  https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy 
  # Ссылка на документацию Robocopy.
